<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Records</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus { outline: none; border-color: #4CAF50; }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        button.small { padding: 5px 10px; font-size: 12px; margin-top: 5px; }
        #status { margin-top: 20px; padding: 15px; border-radius: 4px; display: none; }
        #status.success { display: block; background: #d4edda; color: #155724; }
        #status.error { display: block; background: #f8d7da; color: #721c24; }
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        tr:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>üè• Hospital Records</h1>

    <div class="section">
        <h2>üìù Insert New Record</h2>
        <form id="hospitalForm">
            <div class="form-group">
                <label>Patient ID Hash (64 chars)</label>
                <input type="text" id="patient_id_hash" maxlength="64" required />
                <button type="button" class="small" id="generateBtn">Generate Hash</button>
            </div>
            <div class="form-group">
                <label>Patient Name</label>
                <input type="text" id="patient_name" maxlength="100" placeholder="John Doe" />
            </div>
            <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="patient_dob" />
            </div>
            <div class="form-group">
                <label>Doctor Name</label>
                <input type="text" id="doctor_name" maxlength="100" placeholder="Dr. Smith" />
            </div>
            <div class="form-group">
                <label>Nurse Name</label>
                <input type="text" id="nurse_name" maxlength="100" placeholder="Nurse Johnson" />
            </div>
            <button type="submit">Insert Record</button>
            <button type="button" class="secondary" id="refreshBtn">Refresh Records</button>
        </form>
        <div id="status"></div>
    </div>

    <div class="section">
        <h2>üìã Records</h2>
        <div id="recordsTable"><p>Loading...</p></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchRecords();

            // Generate hash
            document.getElementById('generateBtn').addEventListener('click', function() {
                const chars = '0123456789abcdef';
                let hash = '';
                for (let i = 0; i < 64; i++) {
                    hash += chars[Math.floor(Math.random() * chars.length)];
                }
                document.getElementById('patient_id_hash').value = hash;
            });

            // Refresh
            document.getElementById('refreshBtn').addEventListener('click', fetchRecords);

            // Form submit
            document.getElementById('hospitalForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const record = {
                    patient_id_hash: document.getElementById('patient_id_hash').value.trim(),
                    patient_name: document.getElementById('patient_name').value.trim() || null,
                    patient_dob: document.getElementById('patient_dob').value || null,
                    doctor_name: document.getElementById('doctor_name').value.trim() || null,
                    nurse_name: document.getElementById('nurse_name').value.trim() || null
                };

                if (record.patient_id_hash.length !== 64) {
                    showStatus('Patient ID Hash must be exactly 64 characters!', true);
                    return;
                }

                const res = await fetch('/api/records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
                const { data, error } = await res.json();

                if (error) {
                    showStatus('Error: ' + error, true);
                } else {
                    showStatus('‚úÖ Record inserted! Index: ' + data.record_index);
                    document.getElementById('hospitalForm').reset();
                    fetchRecords();
                }
            });
        });

        function showStatus(msg, isError) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = isError ? 'error' : 'success';
        }

        async function fetchRecords() {
            const res = await fetch('/api/records');
            const { data, error } = await res.json();

            if (error) {
                document.getElementById('recordsTable').innerHTML = '<p style="color:red;">' + error + '</p>';
                return;
            }

            if (!data || data.length === 0) {
                document.getElementById('recordsTable').innerHTML = '<p>No records found.</p>';
                return;
            }

            let html = '<table><thead><tr><th>#</th><th>Patient</th><th>DOB</th><th>Doctor</th><th>Nurse</th><th>Check-in</th></tr></thead><tbody>';
            for (const r of data) {
                html += '<tr><td>' + r.record_index + '</td><td>' + (r.patient_name || '-') + '</td><td>' + (r.patient_dob || '-') + '</td><td>' + (r.doctor_name || '-') + '</td><td>' + (r.nurse_name || '-') + '</td><td>' + (r.check_in_date ? new Date(r.check_in_date).toLocaleString() : '-') + '</td></tr>';
            }
            html += '</tbody></table>';
            document.getElementById('recordsTable').innerHTML = html;
        }
    </script>
</body>
</html>
